<html>
<header>
  <script type="text/JavaScript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.20/lodash.min.js">
</script>
</header>

<body>
  <h1>R3 Showcase Application</h1>
  <div style="display: flex; justify-content: space-around;">
    <div>
      <h2>Manipulate memory inside WebAssembly</h2>
      Adress: <input type="number" id="wasm-address" value="1" /> <br>
      Value: <input type="number" id="wasm-value" value="1" /> <br>
      Type: <select id="store-instr">
        <option value="i32store">i32store</option>
        <option value="i32store8">i32store8</option>
        <option value="i32store16">i32store16</option>
        <option value="i64store">i64store</option>
        <option value="i64store8">i64store8</option>
        <option value="i64store16">i64store16</option>
        <option value="i64store32">i64store32</option>
        <option value="f32store">f32store</option>
        <option value="f64store">f64store</option>
      </select>
      <button id="wasm-change-mem">Manipulate</button>
    </div>
    <div>
      <h2>Manipulate memory from the host</h2>
      Adress: <input type="number" id="host-address" value="1" /> <br>
      Value (Byte): <input type=" number" id="host-value" value="2" /> <br>
      <button id="host-change-mem">Manipulate</button>
    </div>
  </div>
  <p>Load from memory inside WebAssembly from address <input type="number" id="load-address" value="1" />
    <select id="load-instr">
      <option value="i32load">i32load</option>
      <option value="i32load8_u">i32load8_u</option>
      <option value="i32load8_s">i32load8_s</option>
      <option value="i32load16_u">i32load16_u</option>
      <option value="i32load16_s">i32load16_s</option>
      <option value="i64load">i64load</option>
      <option value="i64load8_u">i64load8_u</option>
      <option value="i64load8_s">i64load8_s</option>
      <option value="i64load16_u">i64load16_u</option>
      <option value="i64load16_s">i64load16_s</option>
      <option value="i64load32_u">i64load32_u</option>
      <option value="i64load32_s">i64load32_s</option>
      <option value="f32load">f32load</option>
      <option value="f64load">f64load</option>
    </select><button id="load">Load</button>
  </p>
  <p>Memory state at address <input type="number" id="memory-address" value="1" />: <br>
    Shadow: <span id="shadow-state"></span><br>
    Actual: <span id="actual-state"></span></p>
  <p>Util: <button id="print-shadow">Print shadow memory</button><button id="print-actual">Print actual memory</button>
  </p>
  <h1>Trace: <button id="print-trace">Print trace</button></h1>
  <div id="trace"></div>
  <script type='text/javascript'>
    let instance
    (async function () {
      let wasm = await fetch('index.wasm')
        .then(res => res.arrayBuffer())
        .then(arrayBuffer => WebAssembly.instantiate(arrayBuffer, {}))
      instance = wasm.instance
    })()
    document.getElementById("wasm-change-mem").addEventListener("click", () => {
      let address = document.getElementById("wasm-address").value
      let value = document.getElementById("wasm-value").value
      let instr = document.getElementById("store-instr").value
      if (instr.startsWith("i")) {
        value = parseInt(value)
      } else {
        value = parseFloat(value)
      }
      instance.exports[instr](address, value)
    })
    document.getElementById("host-change-mem").addEventListener("click", () => {
      const memory = new Uint8Array(instance.exports.memory.buffer);
      let address = parseInt(document.getElementById("host-address").value)
      let value = parseInt(document.getElementById("host-value").value)
      memory[address] = value
    })
    document.getElementById("load").addEventListener("click", () => {
      let address = parseInt(document.getElementById("load-address").value)
      let instr = document.getElementById("load-instr").value
      instance.exports[instr](address)
    })
    document.getElementById("print-trace").addEventListener("click", () => {
      console.log(trace)
    })
    document.getElementById("print-shadow").addEventListener("click", () => {
      console.log(new Uint8Array(shadowMemory))
    })
    document.getElementById("print-actual").addEventListener("click", () => {
      console.log(new Uint8Array(actualMemory))
    })
    document.addEventListener("click", update)
    // window.addEventListener("load", update)
    function update() {
      document.getElementById("trace").innerText = stringifyTrace(trace)
      let address = parseInt(document.getElementById("memory-address").value)
      let shadow = new Uint8Array(shadowMemory)
      let actual = new Uint8Array(actualMemory)
      let shadowDump = '['
      let actualDump = '['
      for (let i = 0; i < 8; i++) {
        shadowDump += shadow[address + i] + ', '
        actualDump += actual[address + i] + ', '
      }
      shadowDump += ']'
      actualDump += ']'
      document.getElementById("shadow-state").innerText = shadowDump
      document.getElementById("actual-state").innerText = actualDump
    }
  </script>
  <script src="index.wasabi.js"></script>
  <script src="../../tracer.js"></script>
</body>

</html>